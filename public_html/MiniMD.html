<section class="md-wrap" aria-label="WYSIWYG Markdown Editor">
        <style>
                /* Root section fills <main>; internal layout manages padding/scrolling */
                .md-wrap {
                        display: flex;
                        flex-direction: column;
                        inline-size: 100%;
                        block-size: 100%;
                        flex: 1 1 auto;
                        min-height: 0;
                        /* allow inner flex children to scroll */
                        margin: 0;
                        padding: 0;
                        color: inherit;
                        font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
                }

                .md-action-bar {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 0.5rem 0.75rem;
                        background: #23272e;
                        color: #fff;
                        border-bottom: 1px solid #000;
                        gap: 0.5rem;
                }

                .md-actions-left,
                .md-actions-right {
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        flex-wrap: wrap;
                }

                .md-action-bar button,
                .md-toolbar button {
                        background: #007acc;
                        color: #fff;
                        border: none;
                        border-radius: 4px;
                        padding: 0.35rem 0.6rem;
                        cursor: pointer;
                        font-size: 0.9rem;
                }

                .md-action-bar button:hover,
                .md-toolbar button:hover {
                        background: #005fa3;
                }

                .md-action-bar .secondary,
                .md-toolbar .secondary {
                        background: #3a3f45;
                }

                .md-action-bar .secondary:hover,
                .md-toolbar .secondary:hover {
                        background: #2c3136;
                }

                .md-workspace {
                        flex: 1 1 auto;
                        /* fill remaining height */
                        display: flex;
                        flex-direction: column;
                        min-height: 0;
                        background: var(--color-main-bg, #181a1b);
                        color: var(--color-text, #ececec);
                        border: 1px solid var(--color-border, #333a41);
                        border-top: none;
                }

                .md-top {
                        display: flex;
                        flex: 1 1 auto;
                        min-height: 0;
                        overflow: hidden;
                }

                .md-editor {
                        display: flex;
                        flex-direction: column;
                        width: 45%;
                        min-width: 240px;
                        max-width: 80%;
                        background: #111;
                        border-right: 2px solid #000;
                        min-height: 0;
                }

                .md-toolbar {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 0.25rem;
                        padding: 0.4rem;
                        background: #2a2f35;
                        border-bottom: 1px solid #000;
                }

                .md-toolbar .group {
                        display: inline-flex;
                        gap: 0.25rem;
                        margin-right: 0.35rem;
                }

                .md-textarea {
                        flex: 1 1 auto;
                        min-height: 0;
                        border: none;
                        resize: none;
                        padding: 0.75rem;
                        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
                        font-size: 0.95rem;
                        color: #f8f8f2;
                        background: #1e1e1e;
                        outline: none;
                        line-height: 1.4;
                        tab-size: 2;
                }

                .md-resizer {
                        width: 6px;
                        background: #444;
                        cursor: col-resize;
                        flex: 0 0 6px;
                }

                .md-resizer:hover {
                        background: #666;
                }

                .md-preview {
                        flex: 1 1 auto;
                        min-width: 0;
                        min-height: 0;
                        overflow: auto;
                        background: var(--color-bg, #202427);
                        color: var(--color-text, #ececec);
                        padding: 1rem;
                }

                .md-preview :is(h1, h2, h3, h4, h5, h6) {
                        line-height: 1.25;
                        margin: 1em 0 0.5em;
                }

                .md-preview p {
                        margin: 0.5em 0;
                }

                .md-preview pre {
                        background: #0f1113;
                        color: #e6e6e6;
                        border: 1px solid #000;
                        border-radius: 6px;
                        padding: 0.75rem;
                        overflow: auto;
                }

                .md-preview code:not(pre code) {
                        background: #0f1113;
                        color: #e6e6e6;
                        padding: 0.1rem 0.3rem;
                        border-radius: 4px;
                }

                .md-preview blockquote {
                        border-left: 4px solid #4a90e2;
                        background: #101418;
                        padding: 0.5rem 0.75rem;
                        margin: 0.75rem 0;
                        color: #d9e7ff;
                }

                .md-preview table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 0.75rem 0;
                }

                .md-preview th,
                .md-preview td {
                        border: 1px solid #333;
                        padding: 0.5rem;
                }

                .md-preview a {
                        color: #58aaff;
                }

                /* Preview-only mode */
                .md-preview-only .md-editor {
                        display: none;
                }

                .md-preview-only .md-resizer {
                        display: none;
                }

                /* Mobile */
                @media (max-width: 768px) {
                        .md-editor {
                                width: 55%;
                                min-width: 200px;
                        }

                        .md-toolbar {
                                gap: 0.2rem;
                        }

                        .md-action-bar {
                                gap: 0.4rem;
                        }
                }
        </style>

        <div class="md-action-bar">
                <div class="md-actions-left">
                        <button type="button" data-action="toggle-preview" class="secondary"
                                title="Toggle Preview-only">Preview-only</button>
                        <button type="button" data-action="download">Save</button>
                        <button type="button" data-action="upload" class="secondary">Open</button>
                        <input type="file" data-role="file" accept=".md,.markdown,.txt" hidden>
                </div>
                <div class="md-actions-right">
                        <button type="button" data-action="clear" class="secondary">Clear</button>
                </div>
        </div>

        <div class="md-workspace" data-role="workspace">
                <div class="md-top" data-role="top">
                        <div class="md-editor" data-role="editor">
                                <div class="md-toolbar" role="toolbar" aria-label="Formatting">
                                        <span class="group" aria-label="Headings">
                                                <button type="button" data-md="h1" title="# Heading 1">H1</button>
                                                <button type="button" data-md="h2" title="## Heading 2">H2</button>
                                                <button type="button" data-md="h3" title="### Heading 3">H3</button>
                                        </span>
                                        <span class="group" aria-label="Inline styles">
                                                <button type="button" data-md="bold"
                                                        title="Bold (**text**)"><strong>B</strong></button>
                                                <button type="button" data-md="italic"
                                                        title="Italic (*text*)"><em>I</em></button>
                                                <button type="button" data-md="code"
                                                        title="Inline code (`code`)"><code>{;}</code></button>
                                        </span>
                                        <span class="group" aria-label="Blocks">
                                                <button type="button" data-md="quote"
                                                        title="Blockquote (> text)">‚ùù</button>
                                                <button type="button" data-md="ul" title="Bulleted list (- item)">‚Ä¢
                                                        List</button>
                                                <button type="button" data-md="ol" title="Numbered list (1. item)">1.
                                                        List</button>
                                                <button type="button" data-md="task" title="- [ ] task">‚òê Task</button>
                                                <button type="button" data-md="hr"
                                                        title="Horizontal rule (---)">‚Äî</button>
                                        </span>
                                        <span class="group" aria-label="Links and media">
                                                <button type="button" data-md="link" title="[text](url)">üîó</button>
                                                <button type="button" data-md="image" title="![alt](url)">üñºÔ∏è</button>
                                        </span>
                                        <span class="group" aria-label="Code block and table">
                                                <button type="button" data-md="fence"
                                                        title="``` code block">```</button>
                                                <button type="button" data-md="table" title="Insert table">‚ñ¶</button>
                                        </span>
                                        <span class="group" aria-label="Undo/Redo">
                                                <button type="button" data-md="undo" class="secondary"
                                                        title="Undo">‚Ü∂</button>
                                                <button type="button" data-md="redo" class="secondary"
                                                        title="Redo">‚Ü∑</button>
                                        </span>
                                </div>
                                <textarea class="md-textarea" data-role="textarea" placeholder="# Welcome
      Type Markdown on the left, preview on the right.
      
      - Bold: **text**
      - Italic: *text*
      - Code: `code`
      - Block: ```js ... ```"></textarea>
                        </div>

                        <div class="md-resizer" data-role="resizer" title="Drag to resize editor panel"></div>

                        <div class="md-preview" data-role="preview" aria-live="polite"
                                aria-label="Rendered Markdown Preview">
                                <!-- Rendered HTML appears here -->
                        </div>
                </div>
        </div>

        <script>
                (function () {
                        const root = document.currentScript.closest('.md-wrap');

                        // Elements
                        const textarea = root.querySelector('[data-role="textarea"]');
                        const preview = root.querySelector('[data-role="preview"]');
                        const resizer = root.querySelector('[data-role="resizer"]');
                        const topPanel = root.querySelector('[data-role="top"]');
                        const editorPane = root.querySelector('[data-role="editor"]');
                        const fileInput = root.querySelector('[data-role="file"]');
                        const workspace = root.querySelector('[data-role="workspace"]');

                        // Local storage key
                        const STORAGE_KEY = 'md-editor-content';

                        // Ensure marked is available (load lazily if needed)
                        function ensureMarked(cb) {
                                if (window.marked && typeof window.marked.parse === 'function') return cb();
                                const s = document.createElement('script');
                                s.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
                                s.onload = cb;
                                document.head.appendChild(s);
                        }

                        // Simple sanitizer: removes script/style, event handlers, javascript: URLs, and iframes
                        function sanitize(html) {
                                const tpl = document.createElement('template');
                                tpl.innerHTML = html;
                                const dangerous = ['SCRIPT', 'STYLE'];
                                const walker = document.createTreeWalker(tpl.content, NodeFilter.SHOW_ELEMENT, null);
                                const toRemove = [];
                                while (walker.nextNode()) {
                                        const el = walker.currentNode;
                                        if (dangerous.includes(el.tagName)) {
                                                toRemove.push(el);
                                                continue;
                                        }
                                        // Remove on* attributes
                                        [...el.attributes].forEach(attr => {
                                                const n = attr.name.toLowerCase();
                                                if (n.startsWith('on')) el.removeAttribute(attr.name);
                                                if ((n === 'href' || n === 'src') && /^\s*javascript:/i.test(attr.value)) {
                                                        el.removeAttribute(attr.name);
                                                }
                                        });
                                        // Drop iframes by default
                                        if (el.tagName === 'IFRAME') toRemove.push(el);
                                }
                                toRemove.forEach(n => n.remove());
                                return tpl.innerHTML;
                        }

                        function render() {
                                ensureMarked(() => {
                                        // Configure marked (once)
                                        if (!render._configured) {
                                                marked.setOptions({
                                                        gfm: true,
                                                        breaks: true,
                                                });
                                                render._configured = true;
                                        }
                                        const md = textarea.value || '';
                                        try {
                                                const html = marked.parse(md);
                                                preview.innerHTML = sanitize(html);
                                        } catch (e) {
                                                preview.textContent = String(e);
                                        }
                                });
                        }

                        // Debounced rendering
                        let debounceTimer = null;
                        function scheduleRender() {
                                clearTimeout(debounceTimer);
                                debounceTimer = setTimeout(render, 150);
                        }

                        // Helpers: selection operations in textarea
                        function surroundSelection(before, after, placeholder = 'text') {
                                const el = textarea;
                                const start = el.selectionStart ?? 0;
                                const end = el.selectionEnd ?? 0;
                                const sel = el.value.slice(start, end) || placeholder;
                                const next = el.value.slice(0, start) + before + sel + after + el.value.slice(end);
                                el.value = next;
                                const pos = start + before.length + sel.length;
                                el.focus();
                                el.setSelectionRange(pos, pos);
                                scheduleRender();
                        }

                        function toggleLinePrefix(prefix) {
                                const el = textarea;
                                const start = el.selectionStart ?? 0;
                                const end = el.selectionEnd ?? 0;
                                const value = el.value;
                                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                                const lineEnd = value.indexOf('\n', end);
                                const sliceEnd = lineEnd === -1 ? value.length : lineEnd;

                                const lines = value.slice(lineStart, sliceEnd).split('\n');
                                const allHave = lines.every(l => l.startsWith(prefix));
                                const newLines = lines.map(l => {
                                        if (allHave) return l.replace(new RegExp('^' + prefix.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')), '');
                                        return prefix + l;
                                });
                                const replaced = value.slice(0, lineStart) + newLines.join('\n') + value.slice(sliceEnd);
                                el.value = replaced;

                                // Maintain selection around changed block
                                const deltaPerLine = prefix.length * (allHave ? -1 : 1);
                                const delta = deltaPerLine * lines.length;
                                el.focus();
                                el.setSelectionRange(lineStart, sliceEnd + delta);
                                scheduleRender();
                        }

                        function setHeading(level) {
                                const hashes = '#'.repeat(level) + ' ';
                                const el = textarea;
                                const start = el.selectionStart ?? 0;
                                const value = el.value;
                                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                                const lineEnd = value.indexOf('\n', start);
                                const sliceEnd = lineEnd === -1 ? value.length : lineEnd;

                                const line = value.slice(lineStart, sliceEnd);
                                // Toggle: if same heading exists, remove it; if different level exists, replace
                                const m = /^(#{1,6}\s+)/.exec(line);
                                let newLine;
                                if (m && m[1] === hashes) newLine = line.replace(/^(#{1,6}\s+)/, '');
                                else if (m) newLine = line.replace(/^(#{1,6}\s+)/, hashes);
                                else newLine = hashes + (line || 'Heading');

                                const replaced = value.slice(0, lineStart) + newLine + value.slice(sliceEnd);
                                el.value = replaced;
                                const caret = lineStart + Math.min(newLine.length, replaced.length - lineStart);
                                el.focus();
                                el.setSelectionRange(caret, caret);
                                scheduleRender();
                        }

                        function insertLink() {
                                surroundSelection('[', '](https://example.com)', 'text');
                        }
                        function insertImage() {
                                surroundSelection('![', '](https://placehold.co/600x400)', 'alt');
                        }
                        function insertInlineCode() {
                                surroundSelection('`', '`', 'code');
                        }
                        function insertFence() {
                                const el = textarea;
                                const start = el.selectionStart ?? 0;
                                const end = el.selectionEnd ?? 0;
                                const sel = el.value.slice(start, end) || 'console.log("Hello");';
                                const lang = 'js';
                                const block = '```' + lang + '\n' + sel + '\n```\n';
                                el.setRangeText(block, start, end, 'end');
                                scheduleRender();
                        }
                        function insertTable() {
                                const tmpl = [
                                        '| Column A | Column B | Column C |',
                                        '|----------|----------|----------|',
                                        '| A1       | B1       | C1       |',
                                        '| A2       | B2       | C2       |',
                                        ''
                                ].join('\n');
                                surroundSelection('', '', tmpl);
                        }
                        function insertHR() {
                                surroundSelection('\n\n---\n\n', '', '');
                        }
                        function toggleTasks() {
                                // Convert selected lines to task list, or toggle [ ] <-> [x]
                                const el = textarea;
                                const start = el.selectionStart ?? 0;
                                const end = el.selectionEnd ?? 0;
                                const value = el.value;
                                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                                const lineEnd = value.indexOf('\n', end);
                                const sliceEnd = lineEnd === -1 ? value.length : lineEnd;

                                const lines = value.slice(lineStart, sliceEnd).split('\n');
                                const newLines = lines.map(l => {
                                        if (/^\s*-\s+\[ \]\s/.test(l)) return l.replace('[ ]', '[x]');
                                        if (/^\s*-\s+\[x\]\s/i.test(l)) return l.replace(/\[x\]/i, '[ ]');
                                        if (/^\s*-\s+/.test(l)) return l.replace(/^\s*-\s+/, '- [ ] ');
                                        return '- [ ] ' + l;
                                });
                                const replaced = value.slice(0, lineStart) + newLines.join('\n') + value.slice(sliceEnd);
                                el.value = replaced;
                                el.focus();
                                el.setSelectionRange(lineStart, lineStart + newLines.join('\n').length);
                                scheduleRender();
                        }

                        // Toolbar wiring
                        root.querySelector('.md-toolbar').addEventListener('click', (e) => {
                                const btn = e.target.closest('button[data-md]');
                                if (!btn) return;
                                const action = btn.getAttribute('data-md');
                                switch (action) {
                                        case 'h1': setHeading(1); break;
                                        case 'h2': setHeading(2); break;
                                        case 'h3': setHeading(3); break;
                                        case 'bold': surroundSelection('**', '**', 'bold'); break;
                                        case 'italic': surroundSelection('*', '*', 'italic'); break;
                                        case 'code': insertInlineCode(); break;
                                        case 'quote': toggleLinePrefix('> '); break;
                                        case 'ul': toggleLinePrefix('- '); break;
                                        case 'ol': toggleLinePrefix('1. '); break;
                                        case 'task': toggleTasks(); break;
                                        case 'link': insertLink(); break;
                                        case 'image': insertImage(); break;
                                        case 'fence': insertFence(); break;
                                        case 'table': insertTable(); break;
                                        case 'hr': insertHR(); break;
                                        case 'undo': document.execCommand?.('undo'); break; // best-effort
                                        case 'redo': document.execCommand?.('redo'); break; // best-effort
                                }
                        });

                        // Action bar
                        root.querySelector('[data-action="toggle-preview"]').addEventListener('click', () => {
                                workspace.classList.toggle('md-preview-only');
                        });
                        root.querySelector('[data-action="download"]').addEventListener('click', () => {
                                const blob = new Blob([textarea.value || ''], { type: 'text/markdown' });
                                const a = document.createElement('a');
                                const url = URL.createObjectURL(blob);
                                a.href = url;
                                a.download = 'document.md';
                                document.body.appendChild(a);
                                a.click();
                                a.remove();
                                URL.revokeObjectURL(url);
                        });
                        root.querySelector('[data-action="upload"]').addEventListener('click', () => fileInput.click());
                        fileInput.addEventListener('change', async () => {
                                const file = fileInput.files?.[0];
                                if (!file) return;
                                const text = await file.text();
                                textarea.value = text;
                                scheduleRender();
                        });
                        root.querySelector('[data-action="clear"]').addEventListener('click', () => {
                                textarea.value = '';
                                scheduleRender();
                        });

                        // Editor resizing
                        let resizing = false;
                        resizer.addEventListener('mousedown', () => {
                                resizing = true;
                                document.body.style.cursor = 'col-resize';
                        });
                        document.addEventListener('mousemove', (e) => {
                                if (!resizing) return;
                                const rect = topPanel.getBoundingClientRect();
                                let newWidth = e.clientX - rect.left;
                                const min = 180;
                                const max = rect.width - 180;
                                if (newWidth < min) newWidth = min;
                                if (newWidth > max) newWidth = max;
                                editorPane.style.width = newWidth + 'px';
                        });
                        document.addEventListener('mouseup', () => {
                                if (resizing) {
                                        resizing = false;
                                        document.body.style.cursor = 'default';
                                }
                        });

                        // Input -> preview
                        textarea.addEventListener('input', () => {
                                scheduleRender();
                                try { localStorage.setItem(STORAGE_KEY, textarea.value); } catch { }
                        });

                        // Load previous content if any
                        try {
                                const saved = localStorage.getItem(STORAGE_KEY);
                                if (saved) textarea.value = saved;
                                else textarea.value = '# Hello, Markdown!\n\nStart typing on the left...';
                        } catch {
                                textarea.value = '# Hello, Markdown!\n\nStart typing on the left...';
                        }

                        // Initial render
                        scheduleRender();
                })();
        </script>
</section>