<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>We are a GNU EWE</title>
	<meta name="description" content="A hobby FOSS SPA for bash, html, and a simple python3 web server">
	<meta name="author" content="Tearran (FOSS project)">
	<meta name="robots" content="index, follow">
	<link rel="icon" type="image/svg+xml" href="/favicon.svg">
	<meta name="theme-color" content="#0366d6">
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<link rel="stylesheet" href="style.css">
	<style>
		:root {
			--bg-main: #0d1117;
			--bg-nav: #161b22;
			--border-nav: #21262d;
			--text-main: #fcfcfc;
			--text-link: #58a6ff;
			--text-muted: #8b949e;
			--bg-active: #21262d;
			--radius-main: 5px;
			--font-main: Arial, sans-serif;
			--icon-stroke-width: 1.6;
			--icon-transition: 120ms;
			--icon-color-base: var(--text-main);
			--icon-color-accent: var(--text-link);
			--icon-color-muted: var(--text-muted);
			--icon-color-danger: #ff4d4f;
			--icon-color-warn: #e0a210;
			--icon-color-success: #31c48d;
			--outline-width: 300px;
		}



		/* Highlight currently viewed heading inside document */
		:root {
			--current-heading-outline: 0 0 0 2px rgba(88, 166, 255, 0.5);
		}



		#dynamic-theme {}
	</style>
</head>

<body>
	<nav id="topnav" aria-label="Primary site navigation">
		<div class="nav-inner">
			<span class="nav-title">
				<a href="/" style="color:inherit;text-decoration:none;">
					<img src="images/ewe_hat.svg" alt="Logo" width="64" />
				</a>
			</span>

			<div class="nav-actions">
				<a href="#tags=home&page=home">
					<svg class="icon icon-md">
						<use href="images/icons.svg#i-home"></use>
					</svg>
				</a>
				<button id="open-search" type="button" aria-label="Open search panel">
					<svg class="icon icon-md">
						<use href="images/icons.svg#i-search"></use>
					</svg>
				</button>

				<a href="wysi-pages.html">
					<svg class="icon icon-md">
						<use href="images/icons.svg#i-edit"></use>
					</svg>
				</a>

				<button id="open-theme-dashboard" type="button" aria-label="Open theme dashboard">
					<svg class="icon icon-md">
						<use href="images/icons.svg#i-color"></use>
					</svg>
				</button>
				<button id="open-outline" type="button" aria-label="Open document outline">
					<svg class="icon icon-md">
						<use href="images/icons.svg#i-list"></use>
					</svg>
				</button>
			</div>
		</div>
	</nav>

	<div id="tags-container">
		<div class="tags-header">
			<span id="tags-title"></span>
			<button id="close-sub-menu" type="button" aria-label="Close sub menu">✕</button>
		</div>
		<ul id="tags-list"></ul>
	</div>

	<div id="search-panel" aria-hidden="true">
		<div id="search-box" role="dialog" aria-modal="true" aria-titleledby="search-title">
			<div id="search-header">
				<svg class="icon icon-md">
					<use href="images/icons.svg#i-search"></use>
				</svg>
				<input id="global-search-input" type="text" placeholder="Search documentation..."
					aria-label="Search all documentation" autocomplete="off" />
				<button id="close-search" aria-label="Close search">✕</button>
			</div>
			<div id="search-results" aria-live="polite"></div>
		</div>
	</div>

	<aside id="theme-dashboard" aria-label="Theme dashboard" aria-hidden="true">
		<header>
			Themes
			<button class="close-dashboard" aria-label="Close themes panel">✕</button>
		</header>
		<div class="themes-list" id="themes-list"></div>
	</aside>

	<!-- New Outline Panel -->
	<aside id="outline-panel" aria-label="Document outline" aria-hidden="true">
		<header>
			<span>Outline</span>
			<button class="close-outline" aria-label="Close outline panel">✕</button>
		</header>
		<div id="outline-content" tabindex="0" aria-label="Outline items"></div>
	</aside>

	<div id="content">Loading...</div>

	<footer id="site-footer" class="site-footer" role="contentinfo">
		<div id="footer-links" class="footer-loading">Loading links…</div>
		<div id="footer-about" class="footer-loading">Loading about…</div>
		<div id="footer-legal" class="footer-loading">Loading legal…</div>
	</footer>

	<script src="/js/footer.js"></script>
	<script>
		/* Config */
		const THEME_MANIFEST_URL = 'json/themes.json';
		const DOCS_MANIFEST_URL = 'json/taglinks.json';
		const DEFAULT_DOC = 'pages/home.md';
		const DEFAULT_TAG = 'home';


		/* Markdown loader with caching */
		const markdownCache = new Map();

		/* URL */
		function updateUrlParameters(params) {
			// Build a hash string from parameters object
			const hashParts = [];

			for (const [key, value] of Object.entries(params)) {
				if (value) {
					hashParts.push(`${key}=${encodeURIComponent(value)}`);
				}
			}

			// Use pushState to update URL without reload
			const newHash = hashParts.length > 0 ? '#' + hashParts.join('&') : '';
			if (window.location.hash !== newHash) {
				history.pushState(null, '', newHash);
			}
		}



		// Replace this function to prevent unwanted redirects
		function loadMarkdown(filename, options = {}) {
			const contentEl = document.getElementById('content');
			if (!filename) return;

			// Always skip URL updates when loading from URL parameters
			const skipUrlUpdate = options.skipUrlUpdate === true;

			// Check if this is a tag filter link
			if (typeof filename === 'string' && filename.includes('submenu=')) {
				const term = filename.replace(/^#*submenu=/, '').replace(/^.*?submenu=/, '');
				tagsMenu.show(term);
				return;
			}

			// Regular markdown loading with conditional URL update
			if (markdownCache.has(filename)) {
				contentEl.innerHTML = markdownCache.get(filename);
				enhanceLoadedContent();

				// Only update URL if not loaded from URL parameters
				if (!skipUrlUpdate) {
					const pageName = filename.split('/').pop().replace('.md', '');
					updateUrlParameters({ page: pageName });
				}
				return;
			}

			contentEl.innerHTML = '<div class="loading-spinner"><span class="dot"></span><span class="dot"></span><span class="dot"></span>Loading…</div>';

			fetch(filename)
				.then(r => {
					if (!r.ok) throw new Error('Not found');
					return r.text();
				})
				.then(text => {
					const html = marked.parse(text);
					markdownCache.set(filename, html);
					contentEl.innerHTML = html;
					enhanceLoadedContent();

					// Only update URL if not loaded from URL parameters
					if (!skipUrlUpdate) {
						const pageName = filename.split('/').pop().replace('.md', '');
						updateUrlParameters({ page: pageName });
					}
				})
				.catch(() => {
					contentEl.innerHTML = '<p>Could not load ' + filename + '.</p>';
					clearOutline();
				});
		}

		/* Rest of the code remains the same */

		/* Add IDs to headings (stable slug) and build outline */
		function enhanceLoadedContent() {
			assignHeadingIds();
			buildOutline();
			setupHeadingObserver();
		}

		function slugify(text, existing) {
			let s = text.toLowerCase()
				.replace(/[`~!@#$%^&*()+=<>?,./:;"'|\\[\]{}]/g, '')
				.replace(/\s+/g, '-')
				.replace(/-+/g, '-')
				.replace(/^-|-$/g, '')
				|| 'section';
			let base = s;
			let i = 2;
			while (existing.has(s)) {
				s = base + '-' + i++;
			}
			return s;
		}

		function assignHeadingIds() {
			const contentEl = document.getElementById('content');
			const headings = contentEl.querySelectorAll(outlineState.headingSelector);
			const used = new Set();
			headings.forEach(h => {
				if (!h.id || used.has(h.id)) {
					const txt = h.textContent.trim();
					h.id = slugify(txt, used);
				}
				used.add(h.id);
			});
		}

		function clearOutline() {
			outlineState.items = [];
			const oc = document.getElementById('outline-content');
			if (oc) oc.innerHTML = '<div class="outline-empty">No headings</div>';
		}

		function buildOutline() {
			const contentEl = document.getElementById('content');
			const oc = document.getElementById('outline-content');
			if (!oc) return;
			const headings = [...contentEl.querySelectorAll(outlineState.headingSelector)];
			if (headings.length === 0) {
				clearOutline();
				return;
			}
			// Build flat list with level + id + text
			const items = headings.map(h => ({
				level: parseInt(h.tagName.slice(1), 10),
				id: h.id,
				text: h.textContent.trim()
			}));
			outlineState.items = items;
			// Build nested tree
			const root = [];
			const stack = [];
			items.forEach(item => {
				const node = { ...item, children: [] };
				while (stack.length && stack[stack.length - 1].level >= node.level) stack.pop();
				if (stack.length === 0) {
					root.push(node);
				} else {
					stack[stack.length - 1].children.push(node);
				}
				stack.push(node);
			});
			oc.innerHTML = '';
			if (root.length === 0) {
				clearOutline();
				return;
			}
			const frag = document.createDocumentFragment();
			root.forEach(n => frag.appendChild(renderOutlineNode(n)));
			oc.appendChild(frag);
		}

		function renderOutlineNode(node) {
			const wrapper = document.createElement('div');
			wrapper.style.marginLeft = ((node.level - 1) * 4) + 'px';

			const link = document.createElement('a');
			link.href = '#' + node.id;
			link.className = 'outline-item';
			link.dataset.targetId = node.id;
			link.dataset.level = node.level;
			link.innerHTML = '<span class="lvl">H' + node.level + ':</span>' + escapeHtml(node.text);

			link.addEventListener('click', e => {
				e.preventDefault();
				scrollToHeading(node.id);
			});

			wrapper.appendChild(link);

			if (node.children && node.children.length) {
				link.classList.add('has-children');
				const childrenContainer = document.createElement('div');
				childrenContainer.className = 'outline-children';
				node.children.forEach(ch => {
					childrenContainer.appendChild(renderOutlineNode(ch));
				});
				wrapper.appendChild(childrenContainer);
			}
			return wrapper;
		}

		function scrollToHeading(id) {
			const h = document.getElementById(id);
			if (!h) return;
			h.classList.add('current-heading-flash');
			h.scrollIntoView({ behavior: 'smooth', block: 'start' });
			outlineState.activeId = id;
			updateActiveOutlineItem();
			setTimeout(() => h.classList.remove('current-heading-flash'), 900);
			h.focus?.();
		}

		function updateActiveOutlineItem() {
			const oc = document.getElementById('outline-content');
			if (!oc) return;
			oc.querySelectorAll('.outline-item').forEach(a => {
				a.classList.toggle('active', a.dataset.targetId === outlineState.activeId);
			});
		}

		function setupHeadingObserver() {
			// Disconnect previous
			if (outlineState.observer) {
				outlineState.observer.disconnect();
				outlineState.observer = null;
			}
			const headings = document.querySelectorAll('#content ' + outlineState.headingSelector);
			if (!headings.length) return;
			const opts = {
				root: null,
				rootMargin: '0px 0px -70% 0px', // trigger earlier
				threshold: 0
			};
			outlineState.observer = new IntersectionObserver(entries => {
				entries.forEach(entry => {
					if (entry.isIntersecting) {
						outlineState.activeId = entry.target.id;
						updateActiveOutlineItem();
					}
				});
			}, opts);
			headings.forEach(h => outlineState.observer.observe(h));
		}



		function escapeHtml(s) {
			return s.replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c]));
		}

		/* Search panel object (unchanged except later calls) */
		const searchPanel = {
			root: null, input: null, results: null, openBtn: null, closeBtn: null,
			isOpen: false, activeIndex: -1, flatResults: [], index: [],
			open() {
				this.root.classList.add('open');
				this.root.setAttribute('aria-hidden', 'false');
				this.isOpen = true;
				this.input.value = '';
				this.results.innerHTML = '';
				this.activeIndex = -1;
				this.flatResults = [];
				setTimeout(() => this.input.focus(), 30);
				this.render('');
			},
			close() {
				this.root.classList.remove('open');
				this.root.setAttribute('aria-hidden', 'true');
				this.isOpen = false;
				this.activeIndex = -1;
				this.flatResults = [];
			},
			loadIndex(jsonArray) {
				this.index = (Array.isArray(jsonArray) ? jsonArray : [])
					.filter(it => it.title && it.file)
					.map(it => ({
						title: it.title,
						file: it.file,
						tags: Array.isArray(it.tags) ? it.tags :
							(typeof it.tags === 'string'
								? it.tags.split(',').map(t => t.trim()).filter(Boolean)
								: [])
					}));
			},
			search(term) {
				const q = term.trim().toLowerCase();
				if (!q) return this.index.slice(0, 200);
				function score(e, q) {
					let s = 0;
					if (e.title.toLowerCase().includes(q)) s += 2;
					if (e.file.toLowerCase().includes(q)) s += 0.8;
					if (e.tags.some(t => t.toLowerCase().includes(q))) s += 1;
					return s;
				}
				return this.index
					.map(e => ({ ...e, _s: score(e, q) }))
					.filter(e => e._s > 0)
					.sort((a, b) => b._s - a._s || a.title.localeCompare(b.title))
					.slice(0, 400);
			},
			render(term) {
				const results = this.search(term);
				this.results.innerHTML = '';
				this.flatResults = [];
				if (results.length === 0) {
					const div = document.createElement('div');
					div.className = 'no-results';
					div.textContent = 'No results';
					this.results.appendChild(div);
					return;
				}
				const groupWrap = document.createElement('div');
				groupWrap.className = 'results-group';
				const h = document.createElement('h4');
				h.textContent = 'Documents';
				groupWrap.appendChild(h);
				results.forEach(obj => {
					const div = document.createElement('div');
					div.className = 'result-item';
					div.tabIndex = 0;
					div.dataset.file = obj.file;
					div.innerHTML = '<span class="match-title">' + escapeHtml(obj.title) + '</span>'
						+ '<div class="match-tags">' +
						obj.tags.slice(0, 6).map(t => '<span>' + escapeHtml(t) + '</span>').join('') +
						'</div>';
					div.addEventListener('click', () => {
						loadMarkdown(obj.file);
						searchPanel.close();
					});
					div.addEventListener('keydown', e => {
						if (e.key === 'Enter') {
							loadMarkdown(obj.file);
							searchPanel.close();
						}
					});
					groupWrap.appendChild(div);
					this.flatResults.push(div);
				});
				this.results.appendChild(groupWrap);
				this.activeIndex = this.flatResults.length > 0 ? 0 : -1;
				this.applyActive();
			},
			applyActive() {
				this.flatResults.forEach((el, i) => {
					el.classList.toggle('active', i === this.activeIndex);
				});
			},
			move(delta) {
				if (this.flatResults.length === 0) return;
				this.activeIndex = (this.activeIndex + delta + this.flatResults.length) % this.flatResults.length;
				this.applyActive();
				const el = this.flatResults[this.activeIndex];
				if (el) {
					const parent = this.results;
					const top = el.offsetTop;
					const bottom = top + el.offsetHeight;
					if (top < parent.scrollTop) parent.scrollTop = top - 12;
					else if (bottom > parent.scrollTop + parent.clientHeight) parent.scrollTop = bottom - parent.clientHeight + 12;
				}
			},
			openActive() {
				if (this.activeIndex < 0 || this.activeIndex >= this.flatResults.length) return;
				const el = this.flatResults[this.activeIndex];
				loadMarkdown(el.dataset.file);
				this.close();
			}
		};

		function parseHashParams() {
			const raw = location.hash.startsWith('#') ? decodeURIComponent(location.hash.slice(1)) : '';
			if (!raw) return null;
			const parts = raw.split('&').map(p => p.trim()).filter(Boolean);
			const obj = {};
			parts.forEach(p => {
				const i = p.indexOf('=');
				if (i === -1) return;
				const k = p.slice(0, i).toLowerCase();
				const v = p.slice(i + 1);
				obj[k] = v;
			});
			return Object.keys(obj).length ? obj : null;
		}

		let pendingHashAction = null;

		function applyHashAction(params) {
			if (!params) {
				tagsMenu.show('');
				return;
			}

			if (params.search) {
				if (!searchPanel.isOpen) searchPanel.open();
				searchPanel.input.value = params.search;
				searchPanel.render(params.search);
				return;
			}

			// Handle tags parameter
			if (params.tags) {
				tagsMenu.show(params.tags);
			} else {
				tagsMenu.show('');
			}

			// Handle page parameter
			if (params.page) {
				const pageFile = `pages/${params.page}.md`;
				loadMarkdown(pageFile, { skipUrlUpdate: true });
			}
		}

		window.addEventListener('hashchange', () => {
			const params = parseHashParams();
			if (params && (params.tags || params.submenu) && searchPanel.index.length === 0) {
				pendingHashAction = params;
			} else {
				applyHashAction(params);
			}
		});

	</script>
	<script src="/js/tags_bar.js"></script>
	<script src="/js/markdown_outline.js"></script>
	<script src="js/theme.js"></script>
	<script>
		document.addEventListener('DOMContentLoaded', () => {
			setupThemeDashboard();
			setupOutlinePanel();
			loadThemeManifest();

			// Load docs index
			fetch(DOCS_MANIFEST_URL)
				.then(r => {
					if (!r.ok) throw new Error();
					return r.json();
				})
				.then(json => {
					searchPanel.loadIndex(json);

					// Show default tag - add this line
					tagsMenu.show(DEFAULT_TAG);
				})
				.catch(() => {
					searchPanel.loadIndex([{ title: 'TAGS NOT FOUND', file: DEFAULT_DOC, tags: ['default'] }]);

					// Show default tag even on error - add this line
					tagsMenu.show(DEFAULT_TAG);
				})
				.finally(() => {
					loadMarkdown(DEFAULT_DOC, { skipUrlUpdate: true });
					if (pendingHashAction) {
						applyHashAction(pendingHashAction);
						pendingHashAction = null;
					} else if (initialParams && initialParams.search) {
						searchPanel.render(initialParams.search);
					} else {
						const paramsAfter = parseHashParams();
						if (paramsAfter && (paramsAfter.tags || paramsAfter.submenu))
							applyHashAction(paramsAfter);
					}
				});

			// Add proper nav link handlers
			document.querySelectorAll('#nav-list a').forEach(link => {
				link.addEventListener('click', function (e) {
					const href = this.getAttribute('href');
					if (href && href.includes('submenu=')) {
						e.preventDefault();
						const term = href.replace(/^#*submenu=/, '');
						tagsMenu.show(term);
						updateUrlParameters({ tags: term });
					} else if (href && href.startsWith('#page=')) {
						e.preventDefault();
						const page = href.replace('#page=', '');
						const pageFile = `pages/${page}.md`;
						loadMarkdown(pageFile);
					}
				});
			});

			// Search wiring
			searchPanel.root = document.getElementById('search-panel');
			searchPanel.input = document.getElementById('global-search-input');
			searchPanel.results = document.getElementById('search-results');
			searchPanel.openBtn = document.getElementById('open-search');
			searchPanel.closeBtn = document.getElementById('close-search');
			searchPanel.openBtn.addEventListener('click', () => searchPanel.open());
			searchPanel.closeBtn.addEventListener('click', () => searchPanel.close());
			searchPanel.input.addEventListener('input', function () {
				searchPanel.render(this.value);
			});
			document.addEventListener('keydown', e => {
				if (!searchPanel.isOpen) return;
				if (e.key === 'Escape') {
					searchPanel.close();
					return;
				}
				if (e.key === 'ArrowDown') {
					e.preventDefault();
					searchPanel.move(1);
				} else if (e.key === 'ArrowUp') {
					e.preventDefault();
					searchPanel.move(-1);
				} else if (e.key === 'Enter') {
					e.preventDefault();
					searchPanel.openActive();
				}
			});
			searchPanel.root.addEventListener('mousedown', e => {
				if (e.target === searchPanel.root) searchPanel.close();
			});

			// Initial hash
			const initialParams = parseHashParams();
			if (initialParams) {
				if (initialParams.search) {
					searchPanel.open();
					searchPanel.input.value = initialParams.search;
				} else if (initialParams.tags || initialParams.submenu) {
					pendingHashAction = initialParams;
				}
			}
		});
	</script>
</body>

</html>